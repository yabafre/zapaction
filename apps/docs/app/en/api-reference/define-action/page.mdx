# defineAction

`defineAction` is the core server contract.

```ts
defineAction({
  input: z.object(...),
  output: z.object(...),
  tags: ["users"],
  name: "createUser",
  beforeAction: async ({ input, ctx }) => { ... },
  afterAction: async ({ input, ctx, result }) => { ... },
  handler: async ({ input, ctx }) => { ... },
});
```

## Options

| Option | Type | Required | Description |
|--------|------|----------|-------------|
| `input` | `ZodType<TInput>` | Yes | Input validation schema |
| `output` | `ZodType<TOutput>` | No | Output validation schema |
| `tags` | `readonly string[]` | No | Cache tags for revalidation |
| `name` | `string` | No | Action name for logging |
| `beforeAction` | `(args) => void \| Promise<void>` | No | Pre-handler middleware |
| `afterAction` | `(args) => TOutput \| void \| Promise<...>` | No | Post-handler middleware |
| `handler` | `(args) => Promise<TOutput>` | Yes | Action implementation |

## Pipeline

```
Parse Input → Resolve Context → beforeAction → Handler → afterAction → Validate Output → Revalidate Tags
```

## Validation

- Input is validated before handler execution.
- Output is validated before response (after `afterAction`).
- Validation errors are thrown directly.

## Context

- Register once with `setActionContext(factory)` in server bootstrap.
- Context is resolved for each action invocation.

## Middleware

- `beforeAction`: Throw to abort. Receives parsed input and context. See [Middleware Guide](/en/guide/middleware).
- `afterAction`: Return a value to replace the result. Return void to passthrough. See [Middleware API](/en/api-reference/middleware).

## Error policy

ZapAction does not wrap errors in result envelopes.
