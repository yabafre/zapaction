# defineAction

`defineAction` est le contrat serveur principal.

```ts
defineAction({
  input: z.object(...),
  output: z.object(...),
  tags: ["users"],
  name: "createUser",
  beforeAction: async ({ input, ctx }) => { ... },
  afterAction: async ({ input, ctx, result }) => { ... },
  handler: async ({ input, ctx }) => { ... },
});
```

## Options

| Option | Type | Requis | Description |
|--------|------|--------|-------------|
| `input` | `ZodType<TInput>` | Oui | Schéma de validation de l'input |
| `output` | `ZodType<TOutput>` | Non | Schéma de validation de l'output |
| `tags` | `readonly string[]` | Non | Tags de cache pour la revalidation |
| `name` | `string` | Non | Nom de l'action pour le logging |
| `beforeAction` | `(args) => void \| Promise<void>` | Non | Middleware pré-handler |
| `afterAction` | `(args) => TOutput \| void \| Promise<...>` | Non | Middleware post-handler |
| `handler` | `(args) => Promise<TOutput>` | Oui | Implémentation de l'action |

## Pipeline

```
Parse Input → Resolve Context → beforeAction → Handler → afterAction → Validate Output → Revalidate Tags
```

## Validation

- L'input est validé avant l'exécution du handler.
- L'output est validé avant le retour (après `afterAction`).
- Les erreurs de validation sont throw directement.

## Contexte

- Enregistrez une fois avec `setActionContext(factory)` au bootstrap serveur.
- Le contexte est résolu à chaque invocation.

## Middleware

- `beforeAction` : Throw pour annuler. Reçoit l'input parsé et le contexte. Voir [Guide Middleware](/fr/guide/middleware).
- `afterAction` : Retourner une valeur pour remplacer le résultat. Retourner void pour passthrough. Voir [API Middleware](/fr/api-reference/middleware).

## Politique d'erreur

ZapAction ne wrap pas les erreurs dans une enveloppe de résultat.
