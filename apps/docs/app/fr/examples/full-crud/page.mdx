# CRUD Complet

Cette page est basée sur une vraie application Next.js App Router dans le dépôt :

```txt filename="examples/next-app"
examples/next-app/
```

Vous pouvez la lancer localement et inspecter chaque fichier.

## Lancer l'exemple

```bash
pnpm install
pnpm --filter @zapaction/example-next-app dev
```

Puis ouvrez [http://localhost:3000](http://localhost:3000).

## Structure du projet

| Fichier | Rôle |
|---------|------|
| `app/actions.ts` | Server actions (`listTodos`, `createTodo`, `toggleTodo`, `deleteTodo`) |
| `app/query-keys.ts` | Query keys centralisées |
| `app/providers.tsx` | Provider React Query + tag registry |
| `components/todo-panel.tsx` | Flux client complet : query + mutations + error boundary |

## Actions côté serveur

```ts filename="examples/next-app/app/actions.ts"
// app/actions.ts (simplifié)
"use server";

import { defineAction, setActionContext } from "@zapaction/core";
import { z } from "zod";

setActionContext(async () => ({
  userId: "user-1",
}));

export const createTodo = defineAction({
  name: "createTodo",
  input: z.object({ title: z.string().min(1) }),
  output: todoSchema,
  tags: ["todos"],
  handler: async ({ input }) => {
    const todo = { id: String(nextId++), title: input.title, done: false };
    todos.push(todo);
    return todo;
  },
});

export const toggleTodo = defineAction({
  name: "toggleTodo",
  input: z.object({ id: z.string() }),
  output: todoSchema,
  tags: ["todos"],
  beforeAction: ({ input }) => {
    if (!todos.some((t) => t.id === input.id)) throw new Error("Todo non trouvé");
  },
  handler: async ({ input }) => {
    const todo = todos.find((t) => t.id === input.id)!;
    todo.done = !todo.done;
    return { ...todo };
  },
});
```

## Utilisation côté client

```tsx filename="examples/next-app/components/todo-panel.tsx"
// components/todo-panel.tsx (simplifié)
"use client";

import { useActionMutation, useActionQuery } from "@zapaction/query";
import { ActionErrorBoundary, useActionErrorReset } from "@zapaction/react";

const { data: todos } = useActionQuery(listTodos, {
  input: {},
  queryKey: appKeys.todos(),
  readPolicy: "read-only",
});

const createMutation = useActionMutation(createTodo);
const toggleMutation = useActionMutation(toggleTodo);
const deleteMutation = useActionMutation(deleteTodo);
```

## Ce que cet exemple démontre

| Feature | Où c'est utilisé |
|---------|-----------------|
| `defineAction` avec schémas Zod | Les 4 actions dans `actions.ts` |
| `setActionContext` | Bootstrap serveur dans `actions.ts` |
| `beforeAction` middleware | Validation dans `toggleTodo`, `deleteTodo` |
| `tags` pour l'invalidation | Toutes les actions d'écriture |
| `useActionQuery` | Lecture de la liste de todos |
| `useActionMutation` | Création, bascule, suppression |
| `ActionErrorBoundary` | Encapsulation du todo panel |
| `useActionErrorReset` | Fallback d'erreur avec retry |
| `setTagRegistry` | Configuration du provider client |
