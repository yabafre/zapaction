# Middleware

Utilisez `beforeAction` et `afterAction` pour intercepter le pipeline d'action.

## Pipeline

```
Parse Input → Résoudre Contexte → beforeAction → Handler → afterAction → Valider Output → Revalider Tags
```

## beforeAction

S'exécute **avant** le handler. Lancez une erreur pour annuler.

```ts
export const deleteTodo = defineAction({
  name: "deleteTodo",
  input: z.object({ id: z.string() }),
  output: z.object({ deleted: z.boolean() }),
  tags: ["todos"],
  beforeAction: ({ input, ctx }) => {
    if (!ctx.userId) throw new Error("Authentification requise");
  },
  handler: async ({ input }) => {
    await db.todo.delete({ where: { id: input.id } });
    return { deleted: true };
  },
});
```

### Ce que vous pouvez faire dans `beforeAction`

| ✅ Faire | ❌ Ne pas faire |
|----------|----------------|
| Valider l'authentification | Modifier l'input (lecture seule) |
| Logger l'appel entrant | Retourner une valeur (c'est void) |
| Lancer une erreur pour annuler | Exécuter du travail async lourd |

## afterAction

S'exécute **après** le handler, avant la validation de l'output. Retournez une valeur pour remplacer le résultat.

```ts
export const listTodos = defineAction({
  name: "listTodos",
  input: z.object({}),
  output: z.array(todoSchema),
  afterAction: ({ result }) => {
    return result.sort(
      (a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime(),
    );
  },
  handler: async () => db.todo.findMany(),
});
```

## Composer les middlewares

Créez des wrappers réutilisables :

```ts
import { defineAction, type DefineActionOptions } from "@zapaction/core";

type AppContext = { userId: string };

function protectedAction<TInput, TOutput>(
  options: DefineActionOptions<TInput, TOutput, AppContext>,
) {
  return defineAction({
    ...options,
    beforeAction: async ({ input, ctx }) => {
      if (!ctx.userId) throw new Error("Authentification requise");
      if (options.beforeAction) {
        await options.beforeAction({ input, ctx });
      }
    },
  });
}

// Utilisation
export const deleteTodo = protectedAction({
  name: "deleteTodo",
  input: z.object({ id: z.string() }),
  output: z.object({ deleted: z.boolean() }),
  tags: ["todos"],
  handler: async ({ input }) => {
    await db.todo.delete({ where: { id: input.id } });
    return { deleted: true };
  },
});
```

Voir la [Référence API Middleware](/fr/api-reference/middleware) pour les types.
